<p-dialog
  [header]="trainer.firstname + ' ' + trainer.lastname + ' órarendje'"
  [resizable]="false"
  [modal]="true"
  [(visible)]="dialogVisible"
  [style]="{ width: '95vw' }"
  [contentStyle]="{ height: '500px' }"
>
  <div>
    <div class="pb-3" *ngIf="loggedInUser && loggedInUser?.role === 'ADMIN'">
      <p-toolbar>
        <button
          pButton
          pRipple
          label="Új óra hozzáadása"
          icon="pi pi-plus"
          class="p-button-success mr-2"
          (click)="openNew()"
        ></button>
      </p-toolbar>
    </div>

    <div class="pb-3" *ngIf="!loggedInUser" style="color: red">
      Az órára való jelentkezéshez először be kell jelentkeznie!
    </div>

    <div class="pb-3" *ngIf="loggedInUser && loggedInUser.role === 'TAG'">
      Az óra időpontjára kattintva tud jelentkezni az edzésre! Amennyiben egy
      órára már jelentkezett, az időpontra való kattintással le bír jelentkezni
      róla!
    </div>

    <div class="pb-3" *ngIf="loggedInUser && loggedInUser.role === 'ADMIN'">
      Az óra időpontjára kattintva tudja módosítani az edző órájának adatait,
      valamint elérheti a jelentkezett tagok listáját.
    </div>

    <div class="pb-3">
      <div *ngIf="loggedInUser && loggedInUser.role === 'TAG'">
        Zöld = Már jelentkezett az edzésre
      </div>
      <div>Piros = Az edzés jelenleg inaktív</div>
      <div>Sárga = Az edzésre nincs szabad hely</div>
    </div>

    <p-table
      [value]="displayableScheduleList | async"
      [tableStyle]="{ 'min-width': '50rem' }"
      styleClass="p-datatable-gridlines"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Hétfő</th>
          <th>Kedd</th>
          <th>Szerda</th>
          <th>Csütörtök</th>
          <th>Péntek</th>
          <th>Szombat</th>
          <th>Vasárnap</th>
        </tr>
      </ng-template>
      <ng-template
        pTemplate="body"
        let-schedule
        let-rowData
        let-editing="editing"
        let-ri="rowIndex"
      >
        <tr>
          <td
            [ngClass]="{
              'inactive-training': schedule.monday?.inactive,
              'user-in-training': loggedInUserTrainingIds.includes(
                schedule.monday?.id
              ),
              'training-full':
                schedule.monday &&
                schedule.monday?.attendanceCount ===
                  schedule.monday?.capacity &&
                !loggedInUserTrainingIds.includes(schedule.monday?.id)
            }"
          >
            <a
              (click)="trainingClicked(schedule.monday)"
              *ngIf="schedule.monday"
            >
              {{ schedule.monday?.startTime }} -
              {{ schedule.monday?.endTime }}
              <span *ngIf="schedule.monday"
                >({{ schedule.monday.type }}) [{{
                  schedule.monday?.attendanceCount
                }}/{{ schedule.monday?.capacity }}]
              </span>
            </a>
          </td>
          <td
            [ngClass]="{
              'inactive-training': schedule.tuesday?.inactive,
              'user-in-training': loggedInUserTrainingIds.includes(
                schedule.tuesday?.id
              ),
              'training-full':
                schedule.tuesday &&
                schedule.tuesday?.attendanceCount ===
                  schedule.tuesday?.capacity &&
                !loggedInUserTrainingIds.includes(schedule.tuesday?.id)
            }"
          >
            <a
              (click)="trainingClicked(schedule.tuesday)"
              *ngIf="schedule.tuesday"
            >
              {{ schedule.tuesday?.startTime }} -
              {{ schedule.tuesday?.endTime }}
              <span *ngIf="schedule.tuesday"
                >({{ schedule.tuesday.type }}) [{{
                  schedule.tuesday?.attendanceCount
                }}/{{ schedule.tuesday?.capacity }}]
              </span>
            </a>
          </td>
          <td
            [ngClass]="{
              'inactive-training': schedule.wednesday?.inactive,
              'user-in-training': loggedInUserTrainingIds.includes(
                schedule.wednesday?.id
              ),
              'training-full':
                schedule.wednesday &&
                schedule.wednesday?.attendanceCount ===
                  schedule.wednesday?.capacity &&
                !loggedInUserTrainingIds.includes(schedule.wednesday?.id)
            }"
          >
            <a
              (click)="trainingClicked(schedule.wednesday)"
              *ngIf="schedule.wednesday"
            >
              {{ schedule.wednesday?.startTime }} -
              {{ schedule.wednesday?.endTime }}
              <span *ngIf="schedule.wednesday"
                >({{ schedule.wednesday.type }}) [{{
                  schedule.wednesday?.attendanceCount
                }}/{{ schedule.wednesday?.capacity }}]
              </span>
            </a>
          </td>
          <td
            [ngClass]="{
              'inactive-training': schedule.thursday?.inactive,
              'user-in-training': loggedInUserTrainingIds.includes(
                schedule.thursday?.id
              ),
              'training-full':
                schedule.thursday &&
                schedule.thursday?.attendanceCount ===
                  schedule.thursday?.capacity &&
                !loggedInUserTrainingIds.includes(schedule.thursday?.id)
            }"
          >
            <a
              (click)="trainingClicked(schedule.thursday)"
              *ngIf="schedule.thursday"
            >
              {{ schedule.thursday?.startTime }} -
              {{ schedule.thursday?.endTime }}
              <span *ngIf="schedule.thursday"
                >({{ schedule.thursday.type }}) [{{
                  schedule.thursday?.attendanceCount
                }}/{{ schedule.thursday?.capacity }}]
              </span>
            </a>
          </td>
          <td
            [ngClass]="{
              'inactive-training': schedule.friday?.inactive,
              'user-in-training': loggedInUserTrainingIds.includes(
                schedule.friday?.id
              ),
              'training-full':
                schedule.friday &&
                schedule.friday?.attendanceCount ===
                  schedule.friday?.capacity &&
                !loggedInUserTrainingIds.includes(schedule.friday?.id)
            }"
          >
            <a
              (click)="trainingClicked(schedule.friday)"
              *ngIf="schedule.friday"
            >
              {{ schedule.friday?.startTime }} - {{ schedule.friday?.endTime }}
              <span *ngIf="schedule.friday"
                >({{ schedule.friday.type }}) [{{
                  schedule.friday?.attendanceCount
                }}/{{ schedule.friday?.capacity }}]
              </span>
            </a>
          </td>
          <td
            [ngClass]="{
              'inactive-training': schedule.saturday?.inactive,
              'user-in-training': loggedInUserTrainingIds.includes(
                schedule.saturday?.id
              ),
              'training-full':
                schedule.saturday &&
                schedule.saturday?.attendanceCount ===
                  schedule.saturday?.capacity &&
                !loggedInUserTrainingIds.includes(schedule.saturday?.id)
            }"
          >
            <a
              (click)="trainingClicked(schedule.saturday)"
              *ngIf="schedule.saturday"
            >
              {{ schedule.saturday?.startTime }} -
              {{ schedule.saturday?.endTime }}
              <span *ngIf="schedule.saturday"
                >({{ schedule.saturday.type }}) [{{
                  schedule.saturday?.attendanceCount
                }}/{{ schedule.saturday?.capacity }}]
              </span>
            </a>
          </td>
          <td
            [ngClass]="{
              'inactive-training': schedule.sunday?.inactive,
              'user-in-training': loggedInUserTrainingIds.includes(
                schedule.sunday?.id
              ),
              'training-full':
                schedule.sunday &&
                schedule.sunday?.attendanceCount ===
                  schedule.sunday?.capacity &&
                !loggedInUserTrainingIds.includes(schedule.sunday?.id)
            }"
          >
            <a
              (click)="trainingClicked(schedule.sunday)"
              *ngIf="schedule.sunday"
            >
              {{ schedule.sunday?.startTime }} - {{ schedule.sunday?.endTime }}
              <span *ngIf="schedule.sunday"
                >({{ schedule.sunday.type }}) [{{
                  schedule.sunday?.attendanceCount
                }}/{{ schedule.sunday?.capacity }}]
              </span>
            </a>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
  <ng-template pTemplate="footer">
    <button
      type="button"
      pButton
      pRipple
      icon="pi pi-times"
      (click)="scheduleClosed()"
      label="Bezárás"
      class="p-button-text"
    ></button>
  </ng-template>

  <form #newScheduleForm="ngForm">
    <p-dialog
      [(visible)]="newScheduleDialog"
      [style]="{ width: '450px' }"
      header="Új óra felvitele"
      [modal]="true"
      styleClass="p-fluid"
      [contentStyle]="{ overflow: 'visible' }"
      [draggable]="false"
    >
      <ng-template pTemplate="content">
        <div class="field">
          <label for="day">Nap</label>
          <p-dropdown
            [options]="dayList"
            [(ngModel)]="newSchedule.day"
            name="day"
            [required]="true"
            [autofocus]="true"
            optionLabel="name"
            optionValue="id"
          >
          </p-dropdown>
        </div>
        <div class="field">
          <label for="type">Óra típusa</label>
          <p-dropdown
            [options]="groupTrainingTypeList"
            [(ngModel)]="newSchedule.type"
            name="type"
            [required]="true"
          >
          </p-dropdown>
        </div>
        <div class="field">
          <label for="start">Óra kezdete</label>
          <p-calendar
            inputId="calendar-timeonly"
            [(ngModel)]="newSchedule.start"
            [timeOnly]="true"
            name="start"
            [required]="true"
          >
          </p-calendar>
        </div>
        <div class="field">
          <label for="end">Óra vége</label>
          <p-calendar
            inputId="calendar-timeonly"
            [(ngModel)]="newSchedule.end"
            [timeOnly]="true"
            name="end"
            [required]="true"
          >
          </p-calendar>
        </div>
        <div class="field">
          <label for="capacity">Kapacitás</label>
          <p-inputNumber
            name="capacity"
            required
            [max]="50"
            [min]="1"
            [(ngModel)]="newSchedule.capacity"
          ></p-inputNumber>
        </div>
      </ng-template>
      <ng-template pTemplate="footer">
        <button
          pButton
          pRipple
          label="Mégse"
          icon="pi pi-times"
          class="p-button-text"
          (click)="hideNewDialog()"
        ></button>
        <button
          pButton
          pRipple
          label="Mentés"
          icon="pi pi-check"
          class="p-button-text"
          [disabled]="!newScheduleForm.valid"
          (click)="saveNewSchedule()"
        ></button>
      </ng-template>
    </p-dialog>
  </form>

  <form #editScheduleForm="ngForm">
    <p-dialog
      [(visible)]="editScheduleDialog"
      [style]="{ width: '450px' }"
      header="Óra módosítása"
      [modal]="true"
      styleClass="p-fluid"
      [contentStyle]="{ overflow: 'visible' }"
      [draggable]="false"
    >
      <p-toolbar>
        <button
          pButton
          pRipple
          label="Jelentkezett tagok megtekintése"
          (click)="showUsersInTraining()"
        ></button>
      </p-toolbar>
      <ng-template pTemplate="content">
        <div class="field">
          <label for="day">Nap</label>
          <p-dropdown
            [options]="dayList"
            [(ngModel)]="editedSchedule.day"
            name="day"
            [required]="true"
            [autofocus]="true"
            optionLabel="name"
            optionValue="id"
          >
          </p-dropdown>
        </div>
        <div class="field">
          <label for="type">Óra típusa</label>
          <p-dropdown
            [options]="groupTrainingTypeList"
            [(ngModel)]="editedSchedule.type"
            name="type"
            [required]="true"
          >
          </p-dropdown>
        </div>
        <div class="field">
          <label for="start">Óra kezdete</label>
          <p-calendar
            inputId="calendar-timeonly"
            [(ngModel)]="editedSchedule.start"
            [timeOnly]="true"
            name="start"
            [required]="true"
          >
          </p-calendar>
        </div>
        <div class="field">
          <label for="end">Óra vége</label>
          <p-calendar
            inputId="calendar-timeonly"
            [(ngModel)]="editedSchedule.end"
            [timeOnly]="true"
            name="end"
            [required]="true"
          >
          </p-calendar>
        </div>
        <div class="field">
          <label for="capacity">Kapacitás</label>
          <p-inputNumber
            name="capacity"
            required
            [max]="50"
            [min]="1"
            [(ngModel)]="editedSchedule.capacity"
          ></p-inputNumber>
        </div>
        <div class="field">
          <p-checkbox
            name="inactive"
            [(ngModel)]="editedSchedule.inactive"
            [label]="'Inaktív'"
            [binary]="true"
          ></p-checkbox>
        </div>
      </ng-template>
      <ng-template pTemplate="footer">
        <button
          pButton
          pRipple
          label="Mégse"
          icon="pi pi-times"
          class="p-button-text"
          (click)="hideEditedDialog()"
        ></button>
        <button
          pButton
          pRipple
          label="Mentés"
          icon="pi pi-check"
          class="p-button-text"
          [disabled]="!editScheduleForm.valid"
          (click)="saveEditedSchedule()"
        ></button>
        <button
          pButton
          pRipple
          label="Törlés"
          icon="pi pi-trash"
          class="p-button-text"
          (click)="deleteSchedule()"
        ></button>
      </ng-template>
    </p-dialog>
  </form>
</p-dialog>

<form #usersInTraining="ngForm">
  <p-dialog
    [(visible)]="usersInTrainingDialog"
    header="Jelentkezett tagok"
    [modal]="true"
    styleClass="p-fluid"
    [contentStyle]="{ overflow: 'visible' }"
    [draggable]="false"
  >
    <div class="pb-2">
      A névre kattintva tudja eltávolítani a tagot a jelentkezettek listájából!
    </div>
    <ng-template pTemplate="content">
      <ul>
        <li *ngFor="let userInTraining of usersInTrainingForSchedule">
          <a (click)="removeUserFromTraining(userInTraining)">
            {{ userInTraining.user.firstname }}
            {{ userInTraining.user.lastname }}
          </a>
        </li>
      </ul>
    </ng-template>
    <ng-template pTemplate="footer">
      <button
        pButton
        pRipple
        label="Mégse"
        icon="pi pi-times"
        class="p-button-text"
        (click)="hideUsersInTraining()"
      ></button>
    </ng-template>
  </p-dialog>
</form>
<p-confirmDialog></p-confirmDialog>
